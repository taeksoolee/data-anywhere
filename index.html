<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />

  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <style>
    :root {
      --header-height: 80px;
      --primary-color: #0052CC;
      --primary-lighten-color: #618fd4;
      --error-color: #ff5f38;
      /* --error-lighten-color: #FFBDAD; */
      --error-lighten-color: #fa9b84;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      max-height: 100vh;
      max-width: 100vw;
      min-width: 520px;
      overflow: hidden;
    }

    header {
      height: var(--header-height);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    input {
      padding: 6px 12px; 
      border: 2px solid var(--primary-color); 
      border-radius: 10px;
      outline: none;
    }

    input:focus {
      box-shadow: 0px 0px 3px 3px var(--primary-lighten-color);
    }

    button {
      background-color: var(--primary-color);
      border: none;
      outline: none;
      padding: 5px;
      color: #ffffff;
      cursor: pointer;
    }

    button:hover, button:active {
      box-shadow: 0px 0px 1px 1px var(--primary-lighten-color);
    }

    *[role=link]:active {
      box-shadow: 0px 0px 1px 1px var(--primary-lighten-color);
    }

    #spreadsheet {
      overflow: hidden;
    }

    /* google icon */
    .material-symbols-outlined {
      width: 10px;
      height: 10px;
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24
    }
  </style>
</head>

<body>
  <div style="position: fixed; z-index: 99999; bottom: 0; right: 0; margin: 20px;">
    <form name="secretForm">
      <div style="position: absolute;">
        <div style="position: relative; right: 100%;">
          <input id="secretKey" name="secret-key" type="password" autocomplete="new-password" maxlength="36" />
        </div>
      </div>
      <button id="secretFormSubmitBtn" style="fill: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; transform: scale(1.2) translateY(2.5px);">
        <!-- <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512">! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc.<path d="M256 0c4.6 0 9.2 1 13.4 2.9L457.7 82.8c22 9.3 38.4 31 38.3 57.2c-.5 99.2-41.3 280.7-213.6 363.2c-16.7 8-36.1 8-52.8 0C57.3 420.7 16.5 239.2 16 140c-.1-26.2 16.3-47.9 38.3-57.2L242.7 2.9C246.8 1 251.4 0 256 0zm0 66.8V444.8C394 378 431.1 230.1 432 141.4L256 66.8l0 0z"/></svg> -->
        <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M336 352c97.2 0 176-78.8 176-176S433.2 0 336 0S160 78.8 160 176c0 18.7 2.9 36.8 8.3 53.7L7 391c-4.5 4.5-7 10.6-7 17v80c0 13.3 10.7 24 24 24h80c13.3 0 24-10.7 24-24V448h40c13.3 0 24-10.7 24-24V384h40c6.4 0 12.5-2.5 17-7l33.3-33.3c16.9 5.4 35 8.3 53.7 8.3zM376 96a40 40 0 1 1 0 80 40 40 0 1 1 0-80z"/></svg>
      </button>
    </form>
  </div>
  <header>
    <div style="height: var(--header-height); display: flex; align-items: baseline;">
      <h1 style="display: inline-block; margin-left: 10px;">
        <!-- <span class="material-symbols-outlined">data_table</span> -->
        <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 640 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M352 124.5l-51.9-13c-6.5-1.6-11.3-7.1-12-13.8s2.8-13.1 8.7-16.1l40.8-20.4L294.4 28.8c-5.5-4.1-7.8-11.3-5.6-17.9S297.1 0 304 0H416h32 16c30.2 0 58.7 14.2 76.8 38.4l57.6 76.8c6.2 8.3 9.6 18.4 9.6 28.8c0 26.5-21.5 48-48 48H538.5c-17 0-33.3-6.7-45.3-18.7L480 160H448v21.5c0 24.8 12.8 47.9 33.8 61.1l106.6 66.6c32.1 20.1 51.6 55.2 51.6 93.1C640 462.9 590.9 512 530.2 512H496 432 32.3c-3.3 0-6.6-.4-9.6-1.4C13.5 507.8 6 501 2.4 492.1C1 488.7 .2 485.2 0 481.4c-.2-3.7 .3-7.3 1.3-10.7c2.8-9.2 9.6-16.7 18.6-20.4c3-1.2 6.2-2 9.5-2.2L433.3 412c8.3-.7 14.7-7.7 14.7-16.1c0-4.3-1.7-8.4-4.7-11.4l-44.4-44.4c-30-30-46.9-70.7-46.9-113.1V181.5v-57zM512 72.3c0-.1 0-.2 0-.3s0-.2 0-.3v.6zm-1.3 7.4L464.3 68.1c-.2 1.3-.3 2.6-.3 3.9c0 13.3 10.7 24 24 24c10.6 0 19.5-6.8 22.7-16.3zM130.9 116.5c16.3-14.5 40.4-16.2 58.5-4.1l130.6 87V227c0 32.8 8.4 64.8 24 93H112c-6.7 0-12.7-4.2-15-10.4s-.5-13.3 4.6-17.7L171 232.3 18.4 255.8c-7 1.1-13.9-2.6-16.9-9s-1.5-14.1 3.8-18.8L130.9 116.5z"/></svg>
        <strong style="color: var(--primary-color); margin-left: 10px;">Data</strong>
        <h3 style="display: inline; margin: 5px;">Anywhere</h3>
        <button id="saveBtn" style="margin: 0 5px; fill: white; border-radius: 25px; height: 25px; width: 25px; overflow: hidden; text-wrap: nowrap; transition: width 0.1s ease-in; text-align: left;">
          <svg style="padding-left: 2px;" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M48 96V416c0 8.8 7.2 16 16 16H384c8.8 0 16-7.2 16-16V170.5c0-4.2-1.7-8.3-4.7-11.3l33.9-33.9c12 12 18.7 28.3 18.7 45.3V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96C0 60.7 28.7 32 64 32H309.5c17 0 33.3 6.7 45.3 18.7l74.5 74.5-33.9 33.9L320.8 84.7c-.3-.3-.5-.5-.8-.8V184c0 13.3-10.7 24-24 24H104c-13.3 0-24-10.7-24-24V80H64c-8.8 0-16 7.2-16 16zm80-16v80H272V80H128zm32 240a64 64 0 1 1 128 0 64 64 0 1 1 -128 0z"/></svg>
        </button>
        <button id="copyUrlBtn" style="margin: 0 10px; margin-left: 0px; fill: white; border-radius: 25px; height: 25px; width: 25px; overflow: hidden; text-wrap: nowrap; transition: width 0.1s ease-in; text-align: left;">
          <svg style="padding-left: 2px;" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M280 64h40c35.3 0 64 28.7 64 64V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V128C0 92.7 28.7 64 64 64h40 9.6C121 27.5 153.3 0 192 0s71 27.5 78.4 64H280zM64 112c-8.8 0-16 7.2-16 16V448c0 8.8 7.2 16 16 16H320c8.8 0 16-7.2 16-16V128c0-8.8-7.2-16-16-16H304v24c0 13.3-10.7 24-24 24H192 104c-13.3 0-24-10.7-24-24V112H64zm128-8a24 24 0 1 0 0-48 24 24 0 1 0 0 48z"/></svg>
          <span>&nbsp;Save & Copy URL</span>
        </button>
      </h1>
    </div>
    <a 
      style="
        background-color: var(--primary-color);
        width: calc(var(--header-height) * 1.3);
        height: calc(var(--header-height) * 1.3);
        transform: rotate(225deg) translate(0%, 80%);
      "
      role="link"
      target="_blank"
      href="https://github.com/taeksoolee"
    >
      <svg style="fill: #ffffff;
      transform: rotate(180deg) translate(-34px, -5px) scale(1.5);" 
        xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  </header>
  <div id="spreadsheet"></div>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <!-- <script src="https://unpkg.com/@popperjs/core@2"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" integrity="sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Development -->
  <!-- <script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.min.js"></script>
  <script src="https://unpkg.com/tippy.js@6/dist/tippy-bundle.umd.js"></script> -->

  <!-- Production -->
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>

  <script>

    class Secret {
      _key = new Array(36).fill(' ').join('');

      setKey(key) {
        if (key.length !== 36) {
          if (key.length > 36) {
            key = key.slice(0, 36);
          } else { // key < 36
            key += new Array(36 - key.length).fill(' ').join('');
          }
        }

        this._key = key;
      }

      async encodeByAES56(data){
        const cipher = CryptoJS.AES.encrypt(data, CryptoJS.enc.Utf8.parse(this._key), {
          iv: CryptoJS.enc.Utf8.parse(''),
          padding: CryptoJS.pad.Pkcs7,
          mode: CryptoJS.mode.CBC
        });
        return cipher.toString();
      }

      async decodeByAES256(data){
        const cipher = CryptoJS.AES.decrypt(data, CryptoJS.enc.Utf8.parse(this._key), {
          iv: CryptoJS.enc.Utf8.parse(''),
          padding: CryptoJS.pad.Pkcs7,
          mode: CryptoJS.mode.CBC
        });
        return cipher.toString(CryptoJS.enc.Utf8);
      };
    }

    const secret = new Secret();
    const secretCode = localStorage.getItem('data-anywhere__secret-code') ?? '';
    secret.setKey(secretCode);
    document.querySelector('#secretKey').value = secretCode;
    window.s = secret;

    const createData = (row, col) => {
      return Array.from({ length: row }).map(() => Array.from({ length: col }).map(() => ''));
    }

    const rowSeparator = '^&^';
    const colSeparator = ',,,,,';
    let hot = null;

    async function init() {
      hot && hot.destroy();
      const data = createData(200, 24 * 2);
      const curHash = await secret.decodeByAES256(location.hash.slice(1)).catch(() => null);

      if (curHash) {
        const hashData = curHash.split(rowSeparator).map(e => e.split(colSeparator));

        hashData.forEach(e => {
          if (!e) return;
          const [x, y, value] = e;
          if (!x || x === '#') return;
          data[x][y] = decodeURI(value);
        });  
      } else if (location.hash !== '' && location.hash !== '#' && curHash !== null) {
        console.warn('failed decord');
        document.querySelector('#secretKey').focus();
        Toastify({
          text: "Decord Failed. Please check the Secret. 🔑",
          duration: 3000,
          newWindow: true,
          close: true,
          gravity: "bottom", // `top` or `bottom`
          position: "center", // `left`, `center` or `right`
          stopOnFocus: true, // Prevents dismissing of toast on hover
          style: {
            background: "linear-gradient(to right, var(--error-color), var(--error-lighten-color)",
          },
          onClick: function(){} // Callback after click
        }).showToast();
      }

      const container = document.querySelector('#spreadsheet');
      hot = new Handsontable(container, {
        data,
        rowHeaders: true,
        colHeaders: true,
        height: 'calc(100vh - var(--header-height))',
        // fixedRowsTop: 1,
        licenseKey: 'non-commercial-and-evaluation', // for non-commercial use only
      });

      // window.hot = hot;

      return {
        curHash,
      }
    }

    // hot.addHook('afterChange', (changes, _eventType) => {
    //   const curHash = location.hash;
    //   const data = curHash.split(rowSeparator).map(e => e.split(colSeparator));
    //   changes.forEach(change => {
    //     const [x, y, loadedValue, newValue] = change;
    //     const e = [x, y, newValue]; // .join(colDividerChar);
    //     const fIdx = data.findIndex(e => {
    //       if (!e) return false;
    //       return parseInt(e[0]) === x && parseInt(e[1]) === y
    //     });

    //     if (!newValue) {
    //       console.log(data, x, y, e,fIdx);
    //       if (fIdx !== -1) {
    //         delete data[fIdx];
    //       }
    //     } else {
    //       if (fIdx === -1) {
    //         data.push(e);
    //       } else {
    //         data[fIdx] = e;
    //       }
    //     }
    //   })
    //   location.hash = data.filter((e) => !!e).map(e => e.join(colSeparator)).join(rowSeparator);
    // });

    let saved = false;
    const getHashStr = async () => {
      const curData = hot.getData();

      const hashData = [];
      curData.forEach((row, rIdx) => {
        row.forEach((value, cIdx) => {
          if (value) {
            hashData.push([rIdx, cIdx, value]);
          }
        });
      });
      
      if (hashData.length === 0) return '';

      const hashStr = await secret.encodeByAES56(hashData.map(e => e.join(colSeparator)).join(rowSeparator) ?? '');
      return hashStr;
    }


    const save = (hashStr) => {
      location.hash = hashStr;
      saved = true;

      Toastify({
        text: "Successfully Save. See Url. 💾",
        duration: 3000,
        newWindow: true,
        close: true,
        gravity: "bottom", // `top` or `bottom`
        position: "center", // `left`, `center` or `right`
        stopOnFocus: true, // Prevents dismissing of toast on hover
        style: {
          background: "linear-gradient(to right, var(--primary-color), var(--primary-lighten-color)",
        },
        onClick: function(){} // Callback after click
      }).showToast();
    }

    const copyUrl = (hashStr) => {
      const linkUrl = `${location.protocol}//` + location.host + location.pathname + `#${hashStr}`;
      navigator.clipboard.writeText(linkUrl);

      Toastify({
        text: "Successfully copied the URL to the clipboard! 📎",
        duration: 3000,
        destination: linkUrl,
        newWindow: true,
        close: true,
        gravity: "bottom", // `top` or `bottom`
        position: "center", // `left`, `center` or `right`
        stopOnFocus: true, // Prevents dismissing of toast on hover
        style: {
          background: "linear-gradient(to right, var(--primary-color), var(--primary-lighten-color)",
        },
        onClick: function(){} // Callback after click
      }).showToast();
    }

    document.getElementById('saveBtn').addEventListener('click', async () => {
      const hashStr = await getHashStr(); 
      save(hashStr);
    });

    document.getElementById('copyUrlBtn').addEventListener('click', async () => {
      const hashStr = await getHashStr(); 
      save(hashStr);
      copyUrl(hashStr);
    });

    document.getElementById('copyUrlBtn').addEventListener('mouseenter', function() {
      if (window.innerWidth > 520) {
        this.style.width = '140px';
      }
    });

    document.getElementById('copyUrlBtn').addEventListener('mouseleave', function() {
      this.style.width = '25px';
    });


    window.addEventListener('load', function () {
      init();
    });

    window.addEventListener('scroll', function (e) {
      e.preventDefault();
    });

    window.addEventListener('popstate', function (event) {
      init();
    });

    document.querySelector('#secretKey').addEventListener('focusin', function() {
      this.type = 'text';
      this.autocomplete = "off"
    });
    document.querySelector('#secretKey').addEventListener('focusout', function() {
      this.type = 'password';
      this.autocomplete = "new-password"
    });

    window.secretForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      this.secretKey.blur();
      
      const curHashData = await secret.decodeByAES256(location.hash.slice(1)).catch(() => null);
      const newSecretCode = this.secretKey.value;
      localStorage.setItem('data-anywhere__secret-code', newSecretCode);
      if (saved) {
        secret.setKey(newSecretCode);
        if (curHashData) {
          const newHash  = await secret.encodeByAES56(curHashData);
          location.hash = newHash;
        }
      } else {
        // location.reload();
        secret.setKey(newSecretCode);
        init();
      }
    });

    tippy('#secretFormSubmitBtn', {
      content: "Apply Secret, It operates depending on whether it is saved or not.",
    });
  </script>
</body>

</html>